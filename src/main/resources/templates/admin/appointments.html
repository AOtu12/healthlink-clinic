<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:attr="data-bs-theme=${preferences.theme}"> <!-- Apply theme preference -->
<head>
    <meta charset="UTF-8"/>
    <title>Admin ‚Äì Appointments | HealthLink Clinic</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Mauve theme gradients -->
    <style>
        .mauve-gradient-deep {
            background: linear-gradient(135deg, #6A4C93 0%, #8B5FBF 50%, #9B72CF 100%) !important;
            color: white;
            border: none;
        }
        .mauve-gradient-medium {
            background: linear-gradient(135deg, #8B5FBF 0%, #9B72CF 50%, #B39CD0 100%) !important;
            color: white;
            border: none;
        }
        .mauve-gradient-light {
            background: linear-gradient(135deg, #9B72CF 0%, #B39CD0 50%, #D6C6E9 100%) !important;
            color: white;
            border: none;
        }
        .table-header-mauve {
            background: linear-gradient(135deg, #7A4FA6 0%, #8B5FBF 50%, #9B72CF 100%) !important;
            color: white;
        }
        .table-header-mauve th {
            color: white !important;
            border-bottom: none;
            font-weight: 600;
        }
        html, body {
            height: 100%;
        }

        body {
            display: flex;
            flex-direction: column;
        }

        footer {
            margin-top: auto;
        }

        /* Status badge styles */
        .badge.bg-danger { background-color: #dc3545 !important; }
        .badge.bg-success { background-color: #198754 !important; }
        .badge.bg-warning { background-color: #ffc107 !important; color: #000 !important; }
        .badge.bg-primary { background-color: #0d6efd !important; }
        .badge.bg-secondary { background-color: #6c757d !important; }

        .btn_SUCCESS {
            background: linear-gradient(135deg, #198754 0%, #20c997 100%) !important;
            color: white;
            border: none;
        }
    </style>
</head>

<body class="bg-body-secondary d-flex flex-column min-vh-100"
      th:attr="style=|font-size: ${preferences.fontSize}px|"> <!-- Apply font size preference -->

<!-- ============================ ADMIN NAVBAR ============================ -->
<nav class="navbar navbar-expand-lg bg-dark navbar-dark shadow-sm">
    <div class="container">
        <a class="navbar-brand fw-bold" href="/admin/dashboard">HealthLink Admin</a>

        <!-- Mobile toggle -->
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#adminNavbar">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="adminNavbar">
            <div class="navbar-nav ms-auto">

                <!-- Admin routes -->
                <a class="nav-link" href="/admin/dashboard">Dashboard</a>
                <a class="nav-link" href="/admin/users">Users</a>
                <a class="nav-link" href="/admin/doctors">Doctors</a>
                <a class="nav-link active" href="/admin/appointments">Appointments</a>
                <a class="nav-link" href="/admin/reports">Reports</a>
                <a class="nav-link" href="/admin/settings">Settings</a>

                <!-- Logout -->
                <form th:action="@{/logout}" method="post" class="d-inline ms-3">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <button type="submit" class="btn btn-outline-light btn-sm">Logout</button>
                </form>

            </div>
        </div>
    </div>
</nav>

<div class="container mt-4">

    <!-- Page header -->
    <h1 class="fw-bold mb-3">Admin ‚Äì Appointments</h1>
    <p class="text-muted">Filter, review, and export appointments across the clinic.</p>

    <!-- ============================ FLASH MESSAGES ============================ -->
    <div th:if="${success}" class="alert alert-success alert-dismissible fade show">
        <span th:text="${success}"></span>
        <button class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show">
        <span th:text="${error}"></span>
        <button class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- ============================ FILTER FORM ============================ -->
    <div class="card mb-4 shadow-sm border-0 rounded-3">

        <div class="card-header mauve-gradient-deep">
            <h5 class="mb-0">üîç Filter Appointments</h5>
        </div>

        <div class="card-body">
            <form class="row g-3" th:action="@{/admin/appointments}" method="get">

                <!-- Doctor email filter -->
                <div class="col-md-4">
                    <label class="form-label fw-semibold">Doctor Email</label>
                    <input type="text" class="form-control" name="doctorEmail"
                           placeholder="doctor@example.com"
                           th:value="${doctorEmail}">
                </div>

                <!-- Date filter -->
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Date</label>
                    <input type="date" class="form-control" name="date"
                           th:value="${selectedDate}">
                </div>

                <!-- Status filter -->
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Status</label>
                    <select class="form-select" name="status">

                        <!-- Default option -->
                        <option value="" th:selected="${selectedStatus == null}">
                            All
                        </option>

                        <!-- Enum options -->
                        <option th:each="s : ${allStatuses}"
                                th:value="${s}"
                                th:text="${s}"
                                th:selected="${selectedStatus == s}">
                        </option>

                    </select>
                </div>

                <!-- Apply + Clear -->
                <div class="col-md-2 d-flex align-items-end">
                    <div class="d-flex w-100">
                        <button type="submit" class="btn btn-primary me-2 w-100">Apply</button>
                        <a th:href="@{/admin/appointments}" class="btn btn-outline-secondary w-100">Clear</a>
                    </div>
                </div>

            </form>
        </div>
    </div>

    <!-- ============================ APPOINTMENTS TABLE ============================ -->
    <div class="card shadow-sm border-0 rounded-3">

        <div class="card-header mauve-gradient-medium">
            <h5 class="mb-0">üìÖ Appointments Overview</h5>
        </div>

        <div class="card-body p-0">
            <div class="table-responsive">

                <table class="table table-striped table-hover mb-0 align-middle">

                    <!-- Table header -->
                    <thead class="table-header-mauve">
                    <tr>
                        <th>üìÖ Date</th>
                        <th>‚è∞ Time</th>
                        <th>üë®‚Äç‚öïÔ∏è Doctor</th>
                        <th>üë§ Patient</th>
                        <th>üìä Status</th>
                        <th>üìù Notes</th>
                    </tr>
                    </thead>

                    <tbody>

                    <!-- Empty state -->
                    <tr th:if="${#lists.isEmpty(appointments)}">
                        <td colspan="6" class="text-center text-muted py-4">
                            No appointments found for the selected criteria.
                        </td>
                    </tr>

                    <!-- Appointment rows -->
                    <tr th:each="a : ${appointments}">
                        <td th:text="${a.appointmentDate}"></td>
                        <td th:text="${#temporals.format(a.appointmentTime, 'HH:mm')}"></td>
                        <td th:text="${a.doctor.firstName + ' ' + a.doctor.lastName}"></td>
                        <td th:text="${a.patient.firstName + ' ' + a.patient.lastName}"></td>

                        <!-- Status badge - FIXED: Using string comparison instead of T() operator -->
                        <td>
                            <span class="badge"
                                  th:classappend="${a.status.name() == 'CANCELLED'} ? ' bg-danger' :
                                                  (${a.status.name() == 'COMPLETED'} ? ' bg-success' :
                                                   (${a.status.name() == 'PENDING'} ? ' bg-warning text-dark' :
                                                    (${a.status.name() == 'CONFIRMED'} ? ' bg-primary' : ' bg-secondary')))"
                                  th:text="${a.status}">
                            </span>
                        </td>

                        <td th:text="${a.notes}"></td>
                    </tr>

                    </tbody>
                </table>

            </div>
        </div>

    </div>

    <!-- ============================ CSV EXPORT ============================ -->
    <div class="card mt-4 shadow-sm border-0 rounded-3">

        <div class="card-header mauve-gradient-deep">
            <h5 class="mb-0">üì§ Export Appointments (CSV)</h5>
        </div>

        <div class="card-body">
            <form th:action="@{/admin/reports/appointments/csv}" method="get" class="row g-3">

                <!-- Start date -->
                <div class="col-md-4">
                    <label class="form-label fw-semibold">Start Date</label>
                    <input type="date" name="startDate" class="form-control" required>
                </div>

                <!-- End date -->
                <div class="col-md-4">
                    <label class="form-label fw-semibold">End Date</label>
                    <input type="date" name="endDate" class="form-control" required>
                </div>

                <!-- Download -->
                <div class="col-md-4 d-flex align-items-end">
                    <button type="submit" class="btn btn_SUCCESS w-100">
                        üì• Download CSV
                    </button>
                </div>

            </form>
        </div>

    </div>

</div>

<footer class="text-center mt-5 mb-3 text-muted small mt-auto">
    &copy; 2025 HealthLink Clinic System ‚Äì Admin
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>